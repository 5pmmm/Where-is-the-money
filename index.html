<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…éŠåˆ†å¸³å°å¹«æ‰‹</title>
    <style>
        /* --- æ¥µç°¡ç°è‰²ç³»é¢¨æ ¼ --- */
        :root {
            --bg-color: #F3F4F6;
            --card-bg: #FFFFFF;
            --text-main: #374151;
            --text-sub: #9CA3AF;
            --accent: #4B5563; /* æ·±ç°æŒ‰éˆ• */
            --border: #E5E7EB;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .app-container {
            background-color: var(--card-bg);
            width: 100%;
            max-width: 420px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh; /* è®“å®ƒæœ‰é»åƒAppçš„é«˜åº¦ */
        }

        /* æ¨™é¡Œå€ */
        header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            background: #fff;
        }
        header h2 { margin: 0; font-size: 18px; color: #111; }

        /* å…§å®¹æ²å‹•å€ */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* å€å¡Šæ¨£å¼ */
        .section { margin-bottom: 30px; }
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-sub);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* è¼¸å…¥æ¡†èˆ‡é¸å–® */
        input, select {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: #F9FAFB;
            box-sizing: border-box;
            margin-bottom: 10px;
            color: #333;
        }
        input:focus, select:focus { outline: none; border-color: #999; background: #fff; }

        /* å¤§æ•¸å­—é¡¯ç¤º */
        .big-result {
            font-size: 32px;
            font-weight: bold;
            color: #111;
            text-align: center;
            margin: 10px 0;
        }
        .rate-info { text-align: center; font-size: 12px; color: #888; margin-bottom: 20px; }

        /* æŒ‰éˆ• */
        .btn {
            width: 100%;
            padding: 14px;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.8; }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
            margin-top: 10px;
        }

        /* æˆå“¡å‹¾é¸å€ */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .checkbox-label {
            background: #F3F4F6;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid transparent;
            user-select: none;
        }
        /* å‹¾é¸æ™‚çš„æ¨£å¼ */
        .checkbox-label.checked {
            background: #333;
            color: #fff;
        }
        input[type="checkbox"] { display: none; }

        /* åº•éƒ¨å°èˆªåˆ— */
        .nav-bar {
            display: flex;
            border-top: 1px solid var(--border);
            background: #fff;
        }
        .nav-item {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-size: 12px;
            color: var(--text-sub);
            cursor: pointer;
        }
        .nav-item.active {
            color: #333;
            font-weight: bold;
        }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 4px; }

        /* é é¢åˆ‡æ› */
        .page { display: none; }
        .page.active { display: block; }

        /* åˆ—è¡¨ */
        .list-item {
            background: #fff;
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .debt-item {
            background: #FFF0F0; /* æ¬ éŒ¢è­¦å‘Šè‰² */
            border: none;
            color: #C0392B;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h2 id="headerTitle">åŒ¯ç‡æ›ç®—</h2>
    </header>

    <div class="content">
        
        <div id="page-rate" class="page active">
            <div class="section">
                <div class="section-title">æŒæœ‰è²¨å¹£ (TWD)</div>
                <input type="number" id="twdInput" placeholder="è¼¸å…¥å°å¹£é‡‘é¡" oninput="calcRate()">
            </div>

            <div style="display:flex; justify-content:center; margin-bottom:10px; color:#AAA;">â¬‡ï¸</div>

            <div class="section">
                <div class="section-title">ç›®æ¨™è²¨å¹£</div>
                <select id="currencySelect" onchange="updateCurrency()">
                    <option value="JPY">æ—¥åœ“ (JPY)</option>
                    <option value="USD">ç¾é‡‘ (USD)</option>
                    <option value="KRW">éŸ“å¹£ (KRW)</option>
                    <option value="EUR">æ­å…ƒ (EUR)</option>
                </select>
                <div class="big-result"><span id="resultVal">0</span> <span id="resultUnit" style="font-size:16px;">JPY</span></div>
                <div class="rate-info">ç›®å‰åŒ¯ç‡: 1 TWD â‰ˆ <span id="rateDisplay">--</span> <span id="rateUnit">JPY</span></div>
            </div>
            <div style="text-align:center; font-size:12px; color:#ccc; margin-top:50px;">åŒ¯ç‡ä¾†æº: ExchangeRate-API (å…é‡‘é‘°)</div>
        </div>

        <div id="page-split" class="page">
            
            <div id="setupSection" style="display:none;">
                <div class="section">
                    <div class="section-title">âš™ï¸ è¨­å®šæ—…éŠæˆå“¡ (ç”¨é€—è™Ÿåˆ†éš”)</div>
                    <input type="text" id="membersInput" placeholder="ä¾‹å¦‚ï¼šçˆ¸çˆ¸,åª½åª½,æˆ‘,å¦¹å¦¹" value="æˆ‘,A,B">
                    <button class="btn" onclick="saveMembers()">å„²å­˜æˆå“¡åå–®</button>
                </div>
            </div>

            <div id="accountingSection">
                <div class="section">
                    <div class="section-title">ğŸ’° æ–°å¢èŠ±è²»</div>
                    <input type="text" id="itemNote" placeholder="è²·äº†ä»€éº¼ï¼Ÿ(ä¾‹å¦‚: æ‹‰éºµ)">
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="costInput" placeholder="é‡‘é¡" style="flex:2">
                        <select id="currencyType" style="flex:1">
                            <option value="foreign">å¤–å¹£</option>
                            <option value="twd">å°å¹£</option>
                        </select>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">èª°å…ˆå¢ŠéŒ¢ï¼Ÿ(ä»˜æ¬¾äºº)</div>
                    <select id="payerSelect"></select>
                </div>

                <div class="section">
                    <div class="section-title">èª°è¦åˆ†æ”¤ï¼Ÿ(å—ç›Šäºº)</div>
                    <div class="checkbox-group" id="splittersGroup">
                        </div>
                    <button class="btn btn-outline" onclick="selectAll()">å…¨é¸ / å…¨å–æ¶ˆ</button>
                </div>

                <button class="btn" onclick="addExpense()">è¨˜ä¸€ç­†</button>
                
                <hr style="margin: 30px 0; border:0; border-top:1px solid #EEE;">

                <div class="section">
                    <div class="section-title">ğŸ“Š å‚µå‹™çµç®— (èª°æ¬ èª°)</div>
                    <div id="debtList">
                        <div style="text-align:center; color:#999; padding:20px;">ç›®å‰æ²’æœ‰æ¬ æ¬¾</div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">ğŸ“œ æ¶ˆè²»ç´€éŒ„</div>
                    <div id="historyList"></div>
                    <button class="btn btn-outline" onclick="clearAllData()" style="color:red; border-color:red; margin-top:20px;">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
                </div>
            </div>
        </div>

    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchPage('rate')">
            <span class="nav-icon">ğŸ’±</span>
            åŒ¯ç‡æ›ç®—
        </div>
        <div class="nav-item" onclick="switchPage('split')">
            <span class="nav-icon">ğŸ“</span>
            åˆ†å¸³è¨˜å¸³
        </div>
    </nav>

</div>

<script>
    /* --- 1. å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ– --- */
    let rates = { JPY: 4.7, USD: 0.032, KRW: 42, EUR: 0.029 }; // é è¨­å€¼
    let currentCurrency = 'JPY';
    let members = [];
    let expenses = [];

    // ç¨‹å¼å•Ÿå‹•
    window.onload = function() {
        fetchRates();
        loadData();
        renderMembersUI();
        calcDebts();
        renderHistory();
    };

    /* --- 2. åŒ¯ç‡åŠŸèƒ½ (å… Key API) --- */
    async function fetchRates() {
        try {
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
            const data = await res.json();
            rates = data.rates;
            updateCurrency(); // æ›´æ–°é¡¯ç¤º
            console.log("åŒ¯ç‡æ›´æ–°æˆåŠŸ");
        } catch (e) {
            console.log("ä½¿ç”¨é›¢ç·šåŒ¯ç‡");
        }
    }

    function updateCurrency() {
        currentCurrency = document.getElementById('currencySelect').value;
        document.getElementById('resultUnit').innerText = currentCurrency;
        document.getElementById('rateUnit').innerText = currentCurrency;
        document.getElementById('rateDisplay').innerText = rates[currentCurrency].toFixed(4);
        calcRate();
    }

    function calcRate() {
        const twd = parseFloat(document.getElementById('twdInput').value);
        if(isNaN(twd)) {
            document.getElementById('resultVal').innerText = '0';
            return;
        }
        const val = twd * rates[currentCurrency];
        // æ—¥éŸ“å¹£ä¸é¡¯ç¤ºå°æ•¸
        if(currentCurrency === 'JPY' || currentCurrency === 'KRW') {
            document.getElementById('resultVal').innerText = Math.round(val).toLocaleString();
        } else {
            document.getElementById('resultVal').innerText = val.toFixed(2);
        }
    }

    /* --- 3. æˆå“¡èˆ‡è¨˜å¸³é‚è¼¯ --- */
    
    function loadData() {
        const savedMembers = localStorage.getItem('travel_members');
        const savedExpenses = localStorage.getItem('travel_expenses');
        
        if (savedMembers) {
            members = JSON.parse(savedMembers);
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('accountingSection').style.display = 'block';
        } else {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('accountingSection').style.display = 'none';
        }

        if (savedExpenses) expenses = JSON.parse(savedExpenses);
    }

    function saveMembers() {
        const input = document.getElementById('membersInput').value;
        if(!input.trim()) return alert('è«‹è¼¸å…¥æˆå“¡');
        members = input.split(/[,ï¼Œ]/).map(m => m.trim()).filter(m => m); // æ”¯æ´ä¸­è‹±é€—è™Ÿ
        localStorage.setItem('travel_members', JSON.stringify(members));
        
        location.reload(); // é‡æ–°æ•´ç†ä»¥è¼‰å…¥ä»‹é¢
    }

    function renderMembersUI() {
        if(members.length === 0) return;

        // å¡«å…¥ä»˜æ¬¾äººé¸å–®
        const payerSelect = document.getElementById('payerSelect');
        payerSelect.innerHTML = '';
        members.forEach(m => {
            let opt = document.createElement('option');
            opt.value = m;
            opt.innerText = m;
            payerSelect.appendChild(opt);
        });

        // å¡«å…¥åˆ†æ”¤äºº Checkbox
        const splitGroup = document.getElementById('splittersGroup');
        splitGroup.innerHTML = '';
        members.forEach((m, index) => {
            let label = document.createElement('label');
            label.className = 'checkbox-label checked'; // é è¨­å…¨é¸
            label.innerText = m;
            label.onclick = function() {
                this.classList.toggle('checked');
            };
            splitGroup.appendChild(label);
        });
    }

    function selectAll() {
        const labels = document.querySelectorAll('.checkbox-label');
        // æª¢æŸ¥æ˜¯å¦å·²ç¶“å…¨é¸ï¼Œå¦‚æœæ˜¯å°±å…¨å–æ¶ˆï¼Œå¦å‰‡å…¨é¸
        const allChecked = Array.from(labels).every(l => l.classList.contains('checked'));
        labels.forEach(l => {
            if(allChecked) l.classList.remove('checked');
            else l.classList.add('checked');
        });
    }

    function addExpense() {
        const note = document.getElementById('itemNote').value || 'æœªå‘½åæ¶ˆè²»';
        let cost = parseFloat(document.getElementById('costInput').value);
        const type = document.getElementById('currencyType').value;
        const payer = document.getElementById('payerSelect').value;

        if(isNaN(cost) || cost <= 0) return alert('è«‹è¼¸å…¥æ­£ç¢ºé‡‘é¡');

        // æŠ“å–è¢«å‹¾é¸çš„åˆ†æ”¤äºº
        const splitters = [];
        document.querySelectorAll('.checkbox-label.checked').forEach(l => {
            splitters.push(l.innerText);
        });

        if(splitters.length === 0) return alert('è‡³å°‘è¦æœ‰ä¸€å€‹äººåˆ†æ”¤ï¼');

        // å¦‚æœè¼¸å…¥çš„æ˜¯å¤–å¹£ï¼Œè‡ªå‹•è½‰å›å°å¹£è¨ˆç®— (æ–¹ä¾¿çµç®—)
        let costTWD = cost;
        let displayCost = cost;
        let displayCurrency = 'TWD';

        if(type === 'foreign') {
            // ç”¨ç•¶å‰é¸æ“‡çš„åŒ¯ç‡æ›ç®—å›å°å¹£
            // å…¬å¼ï¼šå¤–å¹£ / åŒ¯ç‡ = å°å¹£
            // æ³¨æ„ï¼šé€™è£¡é‚è¼¯æ˜¯ TWD * Rate = Foreignï¼Œæ‰€ä»¥ Foreign / Rate = TWD
            const rate = rates[currentCurrency]; 
            costTWD = Math.round(cost / rate);
            displayCurrency = currentCurrency;
        } else {
            displayCost = cost;
        }

        // æ–°å¢ç´€éŒ„
        const record = {
            id: Date.now(),
            note: note,
            costTWD: costTWD,
            displayCost: displayCost,
            displayCurrency: displayCurrency,
            payer: payer,
            splitters: splitters
        };

        expenses.unshift(record); // æ”¾æœ€å‰é¢
        localStorage.setItem('travel_expenses', JSON.stringify(expenses));

        // æ¸…ç©ºè¼¸å…¥
        document.getElementById('itemNote').value = '';
        document.getElementById('costInput').value = '';
        alert('è¨˜å¸³æˆåŠŸï¼');

        calcDebts();
        renderHistory();
    }

    /* --- 4. æ ¸å¿ƒæ¼”ç®—æ³•ï¼šç®—èª°æ¬ èª° --- */
    function calcDebts() {
        // 1. åˆå§‹åŒ–æ¯å€‹äººçš„é¤˜é¡ (æ­£=åˆ¥äººæ¬ æˆ‘ï¼Œè² =æˆ‘æ¬ åˆ¥äºº)
        let balances = {};
        members.forEach(m => balances[m] = 0);

        // 2. éæ­·æ¯ä¸€ç­†å¸³
        expenses.forEach(exp => {
            const amount = exp.costTWD;
            const payer = exp.payer;
            const splitters = exp.splitters;
            
            // å…ˆåŠ çµ¦ä»˜æ¬¾äºº (ä»–å¤šä»˜äº†ï¼Œæ‰€ä»¥æ­£æ•¸)
            if(balances[payer] !== undefined) {
                balances[payer] += amount;
            }

            // å†å¾åˆ†æ”¤äººæ‰£æ‰ (ä»–å€‘è©²ä»˜ï¼Œæ‰€ä»¥æ‰£æˆè² æ•¸)
            const splitAmount = amount / splitters.length;
            splitters.forEach(s => {
                if(balances[s] !== undefined) {
                    balances[s] -= splitAmount;
                }
            });
        });

        // 3. é¡¯ç¤ºçµç®—çµæœ
        const list = document.getElementById('debtList');
        list.innerHTML = '';
        
        let hasDebt = false;

        // ç°¡å–®é‚è¼¯ï¼šé¡¯ç¤ºèª°æ˜¯è² çš„ (æ¬ éŒ¢è€…)ï¼Œèª°æ˜¯æ­£çš„ (å‚µä¸»)
        // é€™è£¡ç”¨ç°¡åŒ–é¡¯ç¤ºæ³•ï¼šç›´æ¥åˆ—å‡ºæ¯å€‹äººç•¶ä¸‹çš„æ·¨é¤˜é¡
        
        members.forEach(m => {
            const val = Math.round(balances[m]);
            if(val === 0) return;

            hasDebt = true;
            const div = document.createElement('div');
            div.className = 'list-item';
            
            if(val > 0) {
                // å‚µä¸»
                div.innerHTML = `<span>${m} (æ‡‰æ”¶å›)</span> <b style="color:#27AE60;">+${val}</b>`;
            } else {
                // æ¬ éŒ¢
                div.innerHTML = `<span>${m} (æ‡‰æ”¯ä»˜)</span> <b style="color:#C0392B;">${val}</b>`;
            }
            list.appendChild(div);
        });

        if(!hasDebt) {
            list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ç›®å‰å¸³å‹™å·²çµæ¸… ğŸ‰</div>';
        }
    }

    function renderHistory() {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        expenses.forEach(exp => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.style.display = 'block';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="font-weight:bold;">${exp.note}</span>
                    <span style="font-weight:bold;">${exp.displayCost} ${exp.displayCurrency}</span>
                </div>
                <div style="font-size:12px; color:#666;">
                    ${exp.payer} å…ˆä»˜ <span style="color:#aaa;">âœ</span> åˆ†çµ¦ ${exp.splitters.join(', ')}
                    <br>(ç´„ TWD ${exp.costTWD})
                </div>
            `;
            list.appendChild(div);
        });
    }

    function clearAllData() {
        if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è¨˜å¸³å’Œæˆå“¡è³‡æ–™å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼")) {
            localStorage.clear();
            location.reload();
        }
    }

    /* --- 5. é é¢åˆ‡æ› --- */
    function switchPage(pageName) {
        // åˆ‡æ› Tab æ¨£å¼
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');

        // åˆ‡æ›å…§å®¹é¡¯ç¤º
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.getElementById('page-' + pageName).classList.add('active');
        
        // æ›´æ–°æ¨™é¡Œ
        const titles = { 'rate': 'åŒ¯ç‡æ›ç®—', 'split': 'åˆ†å¸³è¨˜å¸³' };
        document.getElementById('headerTitle').innerText = titles[pageName];
    }
</script>

</body>
</html>