<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>錢錢去哪兒 Where’s the money</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* 自定義滾動條 */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* 動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        @keyframes scaleUp {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-scale-up { animation: scaleUp 0.2s ease-out forwards; }

        /* 隱藏數字輸入框箭頭 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* 底部導航安全區 */
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom, 12px); }
        
        /* UI 輔助類 */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-btn.active { color: #1e293b; }
        .nav-btn.active div { background-color: #f1f5f9; }
    </style>
</head>
<body class="bg-slate-50 text-slate-700 antialiased flex justify-center min-h-screen font-sans">

    <div class="w-full max-w-md bg-slate-50 min-h-screen flex flex-col relative shadow-2xl">
        
        <header class="px-6 pt-8 pb-4 bg-white sticky top-0 z-20 border-b border-slate-100 flex justify-between items-start">
            <div class="flex flex-col">
                <h1 class="text-xl font-bold text-slate-800 tracking-tight">錢錢去哪兒</h1>
                <h2 class="text-sm font-medium text-slate-400 -mt-0.5">Where’s the money</h2>
            </div>
            </header>

        <main class="flex-1 p-6 overflow-y-auto pb-24 scrollbar-hide">
            
            <div id="tab-converter" class="tab-content active animate-fade-in">
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold text-slate-800">匯率計算</h2>
                            <button onclick="fetchRates()" id="refresh-btn" class="p-2 rounded-full hover:bg-slate-100 text-slate-500 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                                </svg>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 focus-within:ring-2 focus-within:ring-slate-200 transition-all">
                                <label class="block text-xs font-medium text-slate-400 mb-1">持有貨幣</label>
                                <div class="flex items-center justify-between">
                                    <input type="number" id="conv-amount" value="1000" class="bg-transparent text-2xl font-bold text-slate-800 focus:outline-none w-full" placeholder="0">
                                    <div class="ml-4 min-w-[100px]">
                                        <select id="conv-from" class="w-full bg-white border border-slate-200 text-slate-700 text-sm rounded-lg p-2.5 outline-none"></select>
                                    </div>
                                </div>
                                <div id="conv-from-label" class="text-right text-xs text-slate-400 mt-1"></div>
                            </div>

                            <div class="flex justify-center -my-2 z-10 relative">
                                <button onclick="swapCurrency()" class="bg-white border border-slate-200 shadow-sm rounded-full p-2 hover:bg-slate-50 text-slate-500 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
                                    </svg>
                                </button>
                            </div>

                            <div class="bg-slate-800 p-4 rounded-xl shadow-md">
                                <label class="block text-xs font-medium text-slate-400 mb-1">換算結果</label>
                                <div class="flex items-center justify-between">
                                    <span id="conv-result" class="text-2xl font-bold text-white truncate pr-4">---</span>
                                    <div class="min-w-[100px]">
                                        <select id="conv-to" class="w-full bg-slate-700 border border-slate-600 text-white text-sm rounded-lg p-2.5 outline-none"></select>
                                    </div>
                                </div>
                                <div class="flex justify-between items-end mt-2">
                                    <div id="conv-rate-display" class="text-xs text-slate-400"></div>
                                    <div id="conv-to-label" class="text-xs text-slate-400 text-right"></div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 text-xs text-slate-400 text-center">
                            上次更新: <span id="last-updated">---</span>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">即時匯率 (1 TWD)</h3>
                        <div id="quick-rates" class="grid grid-cols-2 gap-4">
                            </div>
                    </div>
                </div>
            </div>

            <div id="tab-budget" class="tab-content animate-fade-in">
                <div class="space-y-6">
                    <div class="flex justify-between items-center px-1">
                        <div class="flex flex-col flex-1 mr-4">
                            <span class="text-xs text-slate-400">目前帳本</span>
                            <div id="book-name-display-area" class="mt-0.5"></div>
                        </div>
                        <button onclick="switchBookView('list')" class="text-slate-500 hover:text-slate-800 bg-white border border-slate-200 hover:bg-slate-50 px-3 py-1.5 rounded-full text-xs font-medium shadow-sm flex items-center gap-1 transition-all shrink-0">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                            </svg>
                             帳本紀錄
                        </button>
                    </div>

                    <div class="bg-slate-800 text-white rounded-2xl shadow-lg p-6 transition-all duration-300">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-full">
                                <h2 class="text-slate-400 text-xs uppercase tracking-wider mb-2">目前餘額 (Balance)</h2>
                                <div id="budget-display-area"></div>
                            </div>
                            <div id="budget-btn-container"></div>
                        </div>
                        
                        <div id="budget-progress-area" class="hidden">
                            <div class="relative w-full h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div id="budget-bar" class="absolute top-0 left-0 h-full bg-white transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between mt-2 text-xs text-slate-400">
                                <span id="budget-spent">已花費: NT$ 0</span>
                                <span id="budget-total">總預算: NT$ 0</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-lg font-semibold text-slate-700 mb-4">新增支出</h3>
                        <form onsubmit="addPersonalExpense(event)">
                            <div class="grid grid-cols-3 gap-3 mb-4">
                                <div class="col-span-2">
                                    <label class="block text-xs font-medium text-slate-400 mb-1">金額</label>
                                    <input type="number" id="exp-amount" required placeholder="0" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-slate-800 outline-none focus:ring-2 focus:ring-slate-200">
                                </div>
                                <div class="col-span-1">
                                    <label class="block text-xs font-medium text-slate-400 mb-1">幣別</label>
                                    <select id="exp-currency" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-slate-800 outline-none"></select>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div>
                                    <label class="block text-xs font-medium text-slate-400 mb-1">類別</label>
                                    <select id="exp-category" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-slate-800 outline-none">
                                        </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-400 mb-1">備註</label>
                                    <input type="text" id="exp-note" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-slate-800 outline-none">
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-slate-800 text-white font-medium py-3 rounded-xl hover:bg-slate-700 transition-colors shadow-md active:scale-[0.99]">
                                加入記帳
                            </button>
                        </form>
                    </div>

                    <div id="chart-container" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 hidden">
                        <h3 class="text-sm font-semibold text-slate-500 mb-2">支出分析</h3>
                        <div class="h-48 w-full relative">
                            <canvas id="expenseChart"></canvas>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <h3 class="text-sm font-semibold text-slate-500 px-2">最近紀錄</h3>
                        <div id="expense-list" class="space-y-3"></div>
                    </div>
                </div>
            </div>
            
            <div id="view-book-list" class="tab-content animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-800">帳本紀錄</h2>
                    <button onclick="switchBookView('create')" class="bg-slate-800 text-white text-sm px-4 py-2 rounded-lg shadow-md hover:bg-slate-700 transition-colors flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        新增帳本
                    </button>
                </div>
                <div id="book-list-container" class="space-y-3"></div>
                <button onclick="switchTab('budget')" class="mt-6 text-slate-400 hover:text-slate-600 flex items-center">
                    &larr; 返回記帳
                </button>
            </div>

            <div id="view-book-create" class="tab-content animate-fade-in">
                <button onclick="switchBookView('list')" class="flex items-center text-slate-400 hover:text-slate-600 mb-6">
                    &larr; 返回列表
                </button>
                <h2 class="text-xl font-bold text-slate-800 mb-6">建立新帳本</h2>
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 space-y-6">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">帳本名稱</label>
                        <input type="text" id="new-book-name" placeholder="例如：11月生活費" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-slate-200">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">預算 (NT$)</label>
                        <input type="number" id="new-book-budget" placeholder="0" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-slate-200">
                    </div>
                    <button onclick="createNewBook()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-md">建立帳本</button>
                </div>
            </div>

            <div id="tab-group" class="tab-content animate-fade-in">
                <div id="group-view-list" class="block">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-slate-800">我的旅程</h2>
                        <button onclick="switchGroupView('create')" class="bg-slate-800 text-white text-sm px-4 py-2 rounded-lg shadow-md hover:bg-slate-700 transition-colors">
                            + 新增旅程
                        </button>
                    </div>
                    <div id="trip-list-container" class="space-y-3"></div>
                </div>

                <div id="group-view-create" class="hidden">
                    <button onclick="switchGroupView('list')" class="flex items-center text-slate-400 hover:text-slate-600 mb-6">
                        &larr; 返回
                    </button>
                    <h2 class="text-xl font-bold text-slate-800 mb-6">建立新旅程</h2>
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 space-y-6">
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1">旅程名稱</label>
                            <input type="text" id="new-trip-name" placeholder="例如：墾丁三天兩夜" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-2">成員名單</label>
                            <div id="new-members-tags" class="flex flex-wrap gap-2 mb-3"></div>
                            <div class="flex gap-2">
                                <input type="text" id="new-member-input" placeholder="輸入成員名字" class="flex-1 bg-slate-50 border border-slate-200 rounded-lg p-2 text-sm outline-none">
                                <button onclick="addNewMemberTag()" class="bg-slate-200 text-slate-600 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-300">新增</button>
                            </div>
                        </div>
                        <button onclick="createNewTrip()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-md">開始記帳</button>
                    </div>
                </div>

                <div id="group-view-details" class="hidden space-y-6">
                    <div class="flex items-center gap-3">
                        <button onclick="switchGroupView('list')" class="p-2 rounded-full bg-white border border-slate-200 text-slate-400 hover:text-slate-600">
                            &larr;
                        </button>
                        <div class="flex-1 min-w-0">
                            <h2 id="trip-detail-title" class="text-xl font-bold text-slate-800 leading-tight truncate"></h2>
                            <p id="trip-detail-members" class="text-xs text-slate-400 truncate"></p>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-lg font-semibold text-slate-700 mb-4">新增帳目</h3>
                        <form onsubmit="addGroupExpense(event)" class="space-y-4">
                            <div class="grid grid-cols-3 gap-3">
                                <div class="col-span-2">
                                    <label class="block text-xs text-slate-400 mb-1">項目</label>
                                    <input type="text" id="g-exp-desc" placeholder="例如：晚餐" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 outline-none">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">金額</label>
                                    <input type="number" id="g-exp-amount" placeholder="0" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 outline-none">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">誰先墊付？</label>
                                <select id="g-exp-payer" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 outline-none"></select>
                            </div>
                            <div class="pt-2">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-xs text-slate-400">分攤給誰？</label>
                                    <span id="g-involved-count" class="text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500">全員</span>
                                </div>
                                <div id="g-exp-involved" class="flex flex-wrap gap-2"></div>
                            </div>
                            <button type="submit" class="w-full bg-slate-800 text-white font-medium py-3 rounded-xl hover:bg-slate-700 shadow-md mt-2 active:scale-[0.99]">加入帳目</button>
                        </form>
                    </div>

                    <div class="bg-slate-800 text-white rounded-2xl shadow-lg p-6 relative overflow-hidden group">
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 mb-4">
                                <h3 class="text-xs uppercase tracking-wider text-slate-400">智慧結算</h3>
                            </div>
                            <div class="flex justify-between items-end mb-4">
                                <div>
                                    <div class="text-xs text-slate-400 mb-1">總支出</div>
                                    <div id="g-total-cost" class="text-3xl font-bold">$0</div>
                                </div>
                                <button onclick="showSettlementModal(true)" class="bg-white/10 hover:bg-white/20 text-white text-sm px-4 py-2 rounded-lg backdrop-blur-sm transition-colors flex items-center gap-2">
                                    查看結算明細
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" /></svg>
                                </button>
                            </div>
                        </div>
                        <div class="absolute -right-10 -top-10 w-32 h-32 bg-white/5 rounded-full blur-2xl group-hover:bg-white/10 transition-all"></div>
                    </div>

                    <div class="space-y-3">
                        <h3 class="text-sm font-semibold text-slate-500 px-2">帳目明細</h3>
                        <div id="g-expense-list" class="space-y-3"></div>
                    </div>
                </div>
            </div>

        </main>

        <nav class="bg-white border-t border-slate-200 px-4 py-2 pb-4 sticky bottom-0 z-30 safe-area-pb">
            <div class="flex justify-around items-center">
                <button onclick="switchTab('converter')" id="nav-converter" class="nav-btn active flex flex-col items-center gap-0.5 text-slate-400 transition-colors">
                    <div class="p-1 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" /></svg>
                    </div>
                    <span class="text-xs font-medium">匯率計算</span>
                </button>
                <button onclick="switchTab('budget')" id="nav-budget" class="nav-btn flex flex-col items-center gap-0.5 text-slate-400 transition-colors">
                    <div class="p-1 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" /></svg>
                    </div>
                    <span class="text-xs font-medium">個人記帳</span>
                </button>
                <button onclick="switchTab('group')" id="nav-group" class="nav-btn flex flex-col items-center gap-0.5 text-slate-400 transition-colors">
                    <div class="p-1 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" /></svg>
                    </div>
                    <span class="text-xs font-medium">群組分帳</span>
                </button>
            </div>
        </nav>
        
        <div id="settlement-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm animate-fade-in" onclick="showSettlementModal(false)"></div>
            <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl z-10 overflow-hidden flex flex-col max-h-[85vh] animate-scale-up">
                <div class="bg-slate-800 p-4 text-white flex justify-between items-center shrink-0">
                    <div id="modal-header-content" class="flex items-center gap-2">
                        <h3 class="font-bold text-lg">結算總覽</h3>
                    </div>
                    <button onclick="showSettlementModal(false)" class="p-1 hover:bg-slate-700 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div id="modal-body" class="overflow-y-auto scrollbar-hide"></div>
            </div>
        </div>

    </div>

    <script>
        // --- Data & Config ---
        const STORAGE_KEYS = {
            API_KEY: 'tp_api_key',
            PERSONAL_BOOKS: 'tp_personal_books',
            TRIPS: 'travel_purse_trips'
        };

        const CURRENCIES = {
            TWD: '新台幣', USD: '美金', JPY: '日圓', KRW: '韓元', EUR: '歐元', CNY: '人民幣', GBP: '英鎊', AUD: '澳幣'
        };
        const SYMBOLS = { TWD: 'NT$', USD: '$', JPY: '¥', KRW: '₩', EUR: '€', CNY: '¥', GBP: '£', AUD: 'A$' };
        const CATEGORIES = ['飲食 Food', '交通 Transport', '購物 Shopping', '住宿 Stay', '票券 Ticket', '其他 Other'];

        // Global State
        let state = {
            // API key removed from state
            rates: {},
            lastUpdated: '---',
            
            // Personal Book State
            books: JSON.parse(localStorage.getItem(STORAGE_KEYS.PERSONAL_BOOKS)) || [],
            activeBookId: null,
            
            // Group Trip State
            trips: JSON.parse(localStorage.getItem(STORAGE_KEYS.TRIPS)) || [],
            activeTripId: null,
            newMembers: ['我'],
            currentInvolved: new Set(),
            
            // UI State
            viewDetailMemberId: null // For modal
        };

        let expenseChartInstance = null;

        // --- Initialization ---
        function init() {
            populateSelects();
            
            // Init Personal Book
            if (state.books.length === 0) createDefaultBook();
            else state.activeBookId = state.books[0].id;

            renderConverter();
            renderBookView();
            renderGroupList();
            
            // Listeners
            document.getElementById('conv-amount').addEventListener('input', renderConverterResult);
            document.getElementById('conv-from').addEventListener('change', renderConverterResult);
            document.getElementById('conv-to').addEventListener('change', renderConverterResult);
            
            // 自動抓取免費匯率 (Auto fetch free rates)
            fetchRates();
        }

        function createDefaultBook() {
            const newBook = {
                id: Date.now().toString(),
                name: '本月帳本',
                budget: 0,
                expenses: [],
                createdAt: Date.now()
            };
            state.books = [newBook];
            state.activeBookId = newBook.id;
            saveBooks();
        }

        function saveBooks() {
            localStorage.setItem(STORAGE_KEYS.PERSONAL_BOOKS, JSON.stringify(state.books));
        }
        
        function saveTrips() {
            localStorage.setItem(STORAGE_KEYS.TRIPS, JSON.stringify(state.trips));
        }

        function populateSelects() {
            const opts = Object.keys(CURRENCIES).map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('conv-from').innerHTML = opts;
            document.getElementById('conv-to').innerHTML = opts;
            document.getElementById('conv-to').value = 'JPY';
            document.getElementById('exp-currency').innerHTML = opts;
            document.getElementById('exp-currency').value = 'JPY';
            
            document.getElementById('exp-category').innerHTML = CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function switchTab(tabName) {
            // Hide specific book/group sub-views to reset
            if(tabName === 'budget') switchBookView('detail');
            if(tabName === 'group') switchGroupView('list');

            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            // Budget has nested logic, handle simply here
            if(tabName === 'converter') document.getElementById('tab-converter').classList.add('active');
            if(tabName === 'budget') document.getElementById('tab-budget').classList.add('active');
            if(tabName === 'group') document.getElementById('tab-group').classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('active', 'text-slate-800');
                el.classList.add('text-slate-400');
                el.querySelector('div').classList.remove('bg-slate-100');
            });
            const btn = document.getElementById(`nav-${tabName}`);
            btn.classList.add('active', 'text-slate-800');
            btn.classList.remove('text-slate-400');
            btn.querySelector('div').classList.add('bg-slate-100');
            
            if (tabName === 'budget') renderBookView();
        }

        // --- Feature: Converter (Modified for Free API) ---
        async function fetchRates() {
            const btn = document.getElementById('refresh-btn');
            btn.classList.add('animate-spin');

            try {
                // 使用免費的 ExchangeRate-API
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
                const data = await response.json();
                
                // 存入狀態
                state.rates = data.rates || {};
                state.lastUpdated = new Date().toLocaleTimeString();
                
                document.getElementById('last-updated').textContent = state.lastUpdated;
                renderConverterResult();
                renderQuickRates();
                
            } catch (e) {
                console.error(e);
                alert('匯率更新失敗');
            } finally {
                btn.classList.remove('animate-spin');
            }
        }

        function swapCurrency() {
            const from = document.getElementById('conv-from');
            const to = document.getElementById('conv-to');
            const temp = from.value;
            from.value = to.value;
            to.value = temp;
            renderConverterResult();
        }

        function renderConverterResult() {
            // Labels
            const from = document.getElementById('conv-from').value;
            const to = document.getElementById('conv-to').value;
            document.getElementById('conv-from-label').textContent = CURRENCIES[from];
            document.getElementById('conv-to-label').textContent = CURRENCIES[to];

            const amount = parseFloat(document.getElementById('conv-amount').value) || 0;
            
            let rate = 0;
            if (Object.keys(state.rates).length === 0 && from !== to) {
                document.getElementById('conv-result').textContent = "---";
                document.getElementById('conv-rate-display').textContent = "載入中...";
                return;
            }

            // Logic: ExchangeRate-API gives 1 TWD = X Currency
            if (from === 'TWD') rate = state.rates[to] || 0;
            else if (to === 'TWD') rate = 1 / (state.rates[from] || 1);
            else rate = (state.rates[to] || 0) / (state.rates[from] || 1);

            if (from === to) rate = 1;

            const result = amount * rate;
            let resultText = result.toLocaleString(undefined, { maximumFractionDigits: 2 });
            if (to === 'JPY' || to === 'KRW') resultText = Math.round(result).toLocaleString();
            
            document.getElementById('conv-result').textContent = resultText;
            document.getElementById('conv-rate-display').textContent = `1 ${from} ≈ ${rate.toFixed(4)} ${to}`;
        }

        function renderQuickRates() {
            const container = document.getElementById('quick-rates');
            // 顯示常用貨幣
            container.innerHTML = ['USD','JPY','KRW','EUR','CNY','GBP'].map(code => {
                const val = state.rates[code] ? state.rates[code].toFixed(code === 'JPY' || code === 'KRW' ? 4 : 2) : '-';
                return `
                <div class="flex justify-between items-center p-3 rounded-lg bg-slate-50 border border-slate-100">
                    <span class="font-medium text-slate-700">${code}</span>
                    <span class="font-mono text-slate-600">${val}</span>
                </div>`;
            }).join('');
        }

        function renderConverter() {
            renderConverterResult();
            renderQuickRates();
        }


        // --- Feature: Personal Expense ---
        function getActiveBook() {
            return state.books.find(b => b.id === state.activeBookId) || state.books[0];
        }

        function switchBookView(view) {
            document.getElementById('tab-budget').classList.remove('active');
            document.getElementById('view-book-list').classList.remove('active');
            document.getElementById('view-book-create').classList.remove('active');

            if(view === 'detail') {
                document.getElementById('tab-budget').classList.add('active');
                renderBookView();
            } else if (view === 'list') {
                document.getElementById('view-book-list').classList.add('active');
                renderBookList();
            } else if (view === 'create') {
                document.getElementById('view-book-create').classList.add('active');
            }
        }

        function renderBookView() {
            const book = getActiveBook();
            if(!book) return;

            // Header Name (Editable)
            const nameContainer = document.getElementById('book-name-display-area');
            if(!nameContainer.querySelector('input')) {
                nameContainer.innerHTML = `
                <div onclick="toggleBookNameEdit(true)" class="flex items-center gap-2 group cursor-pointer py-1" title="點擊修改名稱">
                    <h2 class="text-lg font-bold text-slate-700 truncate max-w-[200px]">${book.name}</h2>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-slate-300 group-hover:text-slate-500"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                </div>`;
            }

            // Budget
            const totalSpent = book.expenses.reduce((acc, curr) => acc + curr.amountInBase, 0);
            const remaining = book.budget - totalSpent;
            const hasBudget = book.budget > 0;

            const budgetArea = document.getElementById('budget-display-area');
            const btnContainer = document.getElementById('budget-btn-container');
            const progressArea = document.getElementById('budget-progress-area');

            if (!budgetArea.querySelector('input')) {
                if (!hasBudget) {
                    budgetArea.innerHTML = `<button onclick="toggleBudgetEdit(true)" class="text-lg font-bold text-slate-300 hover:text-white border-b border-dashed border-slate-600 pb-1 mt-1">設定預算</button>`;
                    btnContainer.innerHTML = '';
                    progressArea.classList.add('hidden');
                } else {
                    budgetArea.innerHTML = `<div class="text-3xl font-bold">NT$ ${Math.round(remaining).toLocaleString()}</div>`;
                    btnContainer.innerHTML = `
                    <button onclick="toggleBudgetEdit(true)" class="text-slate-400 hover:text-white ml-2 p-2 hover:bg-slate-700 rounded-full transition-all">
                        <span class="text-[10px] border border-slate-500 px-2 py-1 rounded-full hover:border-white whitespace-nowrap">設定預算</span>
                    </button>`;
                    progressArea.classList.remove('hidden');
                    const pct = Math.min(100, (totalSpent / book.budget) * 100);
                    document.getElementById('budget-bar').style.width = `${pct}%`;
                    document.getElementById('budget-bar').className = `absolute top-0 left-0 h-full transition-all duration-500 ${remaining < 0 ? 'bg-red-500' : 'bg-white'}`;
                    document.getElementById('budget-spent').textContent = `已花費: NT$ ${Math.round(totalSpent).toLocaleString()}`;
                    document.getElementById('budget-total').textContent = `總預算: NT$ ${book.budget.toLocaleString()}`;
                }
            }

            renderExpenseList();
            renderChart();
        }

        function toggleBookNameEdit(editing) {
            const container = document.getElementById('book-name-display-area');
            const book = getActiveBook();
            if(editing) {
                container.innerHTML = `
                <div class="flex items-center gap-2 mt-0.5 animate-fade-in">
                    <input type="text" id="edit-book-name" value="${book.name}" class="bg-white border border-slate-300 rounded-md px-2 py-1 text-sm font-bold text-slate-700 w-full max-w-[150px] outline-none focus:ring-2 focus:ring-slate-200" onkeydown="if(event.key==='Enter') saveBookName()">
                    <button onclick="saveBookName()" class="w-6 h-6 rounded-full bg-green-100 text-green-600 flex items-center justify-center">✓</button>
                </div>`;
                document.getElementById('edit-book-name').focus();
            } else {
                renderBookView();
            }
        }

        function saveBookName() {
            const val = document.getElementById('edit-book-name').value.trim();
            if(val) {
                const book = getActiveBook();
                book.name = val;
                saveBooks();
            }
            toggleBookNameEdit(false);
        }

        function toggleBudgetEdit(editing) {
            const area = document.getElementById('budget-display-area');
            const book = getActiveBook();
            if (editing) {
                area.innerHTML = `
                <div class="animate-fade-in w-full">
                    <div class="flex items-baseline border-b-2 border-slate-600 pb-1 mb-3">
                        <span class="text-2xl text-slate-400 mr-2 font-medium">NT$</span>
                        <input type="number" id="new-budget-input" value="${book.budget === 0 ? '' : book.budget}" class="w-full bg-transparent text-4xl font-bold text-white placeholder-slate-600 outline-none" autofocus onkeydown="if(event.key==='Enter') saveBudget()">
                    </div>
                    <div class="flex gap-3 justify-end">
                        <button onclick="saveBudget()" class="w-8 h-8 rounded-full bg-white text-slate-900 flex items-center justify-center font-bold">✓</button>
                        <button onclick="renderBookView()" class="w-8 h-8 rounded-full bg-slate-700 text-slate-300 flex items-center justify-center">✕</button>
                    </div>
                </div>`;
                document.getElementById('new-budget-input').focus();
            } else {
                renderBookView();
            }
        }

        function saveBudget() {
            const val = Number(document.getElementById('new-budget-input').value);
            const book = getActiveBook();
            book.budget = val;
            saveBooks();
            // Clear the input flag by re-rendering
            document.getElementById('budget-display-area').innerHTML = ''; 
            renderBookView();
        }

        function renderBookList() {
            const container = document.getElementById('book-list-container');
            container.innerHTML = state.books.map(book => {
                 const spent = book.expenses.reduce((acc, curr) => acc + curr.amountInBase, 0);
                 const isActive = book.id === state.activeBookId;
                 return `
                 <div onclick="selectBook('${book.id}')" class="relative p-4 rounded-2xl shadow-sm border cursor-pointer transition-all group ${isActive ? 'bg-slate-50 border-slate-400 ring-1 ring-slate-400' : 'bg-white border-slate-200'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-slate-800">${book.name}</h3>
                            <p class="text-xs text-slate-400 mt-1">${new Date(book.createdAt).toLocaleDateString()} • ${book.expenses.length} 筆</p>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold text-slate-700">支出 $${Math.round(spent).toLocaleString()}</div>
                            <div class="text-xs text-slate-400">預算 $${book.budget.toLocaleString()}</div>
                        </div>
                    </div>
                    <button onclick="deleteBook('${book.id}', event)" class="absolute bottom-3 right-3 p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full opacity-0 group-hover:opacity-100 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                    </button>
                 </div>`;
            }).join('');
        }

        function selectBook(id) {
            state.activeBookId = id;
            switchBookView('detail');
        }

        function createNewBook() {
            const name = document.getElementById('new-book-name').value;
            const budget = document.getElementById('new-book-budget').value;
            if(!name) { alert('請輸入名稱'); return; }
            const newBook = {
                id: Date.now().toString(),
                name,
                budget: Number(budget),
                expenses: [],
                createdAt: Date.now()
            };
            state.books.unshift(newBook);
            saveBooks();
            document.getElementById('new-book-name').value = '';
            document.getElementById('new-book-budget').value = '';
            selectBook(newBook.id);
        }

        function deleteBook(id, e) {
            e.stopPropagation();
            if(confirm('確定刪除此帳本?')) {
                state.books = state.books.filter(b => b.id !== id);
                if(state.books.length === 0) createDefaultBook();
                else if (state.activeBookId === id) state.activeBookId = state.books[0].id;
                saveBooks();
                renderBookList();
            }
        }

        function addPersonalExpense(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('exp-amount').value);
            const currency = document.getElementById('exp-currency').value;
            const category = document.getElementById('exp-category').value;
            const note = document.getElementById('exp-note').value;
            
            let rate = 1;
            // Logic: Use free API rate (base TWD)
            if (currency !== 'TWD') {
                const r = state.rates[currency];
                if (!r) { 
                    // If rate missing (offline/error), fallback to 1 or keep foreign
                    rate = 1; 
                } else {
                    // 1 TWD = r Foreign => 1 Foreign = 1/r TWD
                    rate = 1/r;
                }
            }

            const newExp = {
                id: Date.now().toString(),
                amount, currency, amountInBase: amount * rate, category, note, date: new Date().toLocaleDateString()
            };
            const book = getActiveBook();
            book.expenses.unshift(newExp);
            saveBooks();
            
            document.getElementById('exp-amount').value = '';
            document.getElementById('exp-note').value = '';
            renderBookView();
        }

        function deletePersonalExpense(id) {
            if(confirm('確定刪除?')) {
                const book = getActiveBook();
                book.expenses = book.expenses.filter(e => e.id !== id);
                saveBooks();
                renderBookView();
            }
        }

        function renderExpenseList() {
            const book = getActiveBook();
            document.getElementById('expense-list').innerHTML = book.expenses.map(exp => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center relative group">
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 text-xs font-bold">
                            ${exp.category.substring(0, 2)}
                        </div>
                        <div>
                            <div class="text-sm font-medium text-slate-800">${exp.note || exp.category}</div>
                            <div class="text-xs text-slate-400">${exp.date}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-bold text-slate-800">${SYMBOLS[exp.currency]}${exp.amount.toLocaleString()}</div>
                        ${exp.currency !== 'TWD' ? `<div class="text-xs text-slate-400">≈ NT$ ${Math.round(exp.amountInBase).toLocaleString()}</div>` : ''}
                    </div>
                    <button onclick="deletePersonalExpense('${exp.id}')" class="absolute top-2 right-2 p-1 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            `).join('');
        }

        function renderChart() {
            const book = getActiveBook();
            const container = document.getElementById('chart-container');
            const ctx = document.getElementById('expenseChart');
            
            if(book.expenses.length === 0) {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');
            
            const dataMap = {};
            book.expenses.forEach(e => dataMap[e.category] = (dataMap[e.category] || 0) + e.amountInBase);
            
            if(expenseChartInstance) expenseChartInstance.destroy();
            expenseChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dataMap),
                    datasets: [{
                        data: Object.values(dataMap),
                        backgroundColor: ['#64748b', '#94a3b8', '#cbd5e1', '#475569', '#334155', '#1e293b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } } }
                }
            });
        }

        // --- Feature: Group Splitter ---
        function switchGroupView(view) {
            ['list', 'create', 'details'].forEach(v => {
                document.getElementById(`group-view-${v}`).classList.add('hidden');
            });
            document.getElementById(`group-view-${view}`).classList.remove('hidden');
            if(view === 'list') renderGroupList();
        }

        function renderGroupList() {
            const container = document.getElementById('trip-list-container');
            if(state.trips.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center py-16 bg-white rounded-2xl border border-dashed border-slate-300"><p class="text-slate-500 font-medium">還沒有任何旅程</p></div>`;
                return;
            }
            container.innerHTML = state.trips.map(trip => `
            <div onclick="openTrip('${trip.id}')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 cursor-pointer flex justify-between items-center group">
                <div>
                    <h3 class="font-bold text-slate-800">${trip.name}</h3>
                    <p class="text-xs text-slate-400 mt-1">${trip.members.length} 位成員 • ${trip.expenses.length} 筆帳目</p>
                </div>
                <button onclick="deleteTrip('${trip.id}', event)" class="p-3 text-slate-300 hover:text-red-500 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                </button>
            </div>`).join('');
        }

        function addNewMemberTag() {
            const input = document.getElementById('new-member-input');
            const val = input.value.trim();
            if(val) {
                state.newMembers.push(val);
                input.value = '';
                renderNewMembers();
            }
        }
        
        function renderNewMembers() {
            document.getElementById('new-members-tags').innerHTML = state.newMembers.map((m, i) => `
            <div class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-sm flex items-center">
                ${m} <button onclick="state.newMembers.splice(${i},1); renderNewMembers()" class="ml-2 text-slate-300 hover:text-red-400">×</button>
            </div>`).join('');
        }

        function createNewTrip() {
            const name = document.getElementById('new-trip-name').value;
            if(!name || state.newMembers.length === 0) { alert('請填寫完整'); return; }
            const newTrip = {
                id: Date.now().toString(),
                name,
                members: state.newMembers.map((n,i) => ({id: `${Date.now()}-${i}`, name: n})),
                expenses: [], lastUpdated: Date.now()
            };
            state.trips.unshift(newTrip);
            saveTrips();
            // Reset
            document.getElementById('new-trip-name').value = '';
            state.newMembers = ['我'];
            renderNewMembers();
            openTrip(newTrip.id);
        }

        function deleteTrip(id, e) {
            e.stopPropagation();
            if(confirm('確定刪除此旅程?')) {
                state.trips = state.trips.filter(t => t.id !== id);
                saveTrips();
                renderGroupList();
            }
        }

        function openTrip(id) {
            state.activeTripId = id;
            const trip = state.trips.find(t => t.id === id);
            document.getElementById('trip-detail-title').textContent = trip.name;
            document.getElementById('trip-detail-members').textContent = trip.members.map(m=>m.name).join(', ');
            
            // Setup Form
            document.getElementById('g-exp-payer').innerHTML = trip.members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            state.currentInvolved = new Set(trip.members.map(m=>m.id));
            renderInvolvedButtons();
            
            renderGroupExpenses();
            switchGroupView('details');
        }

        function renderInvolvedButtons() {
            const trip = state.trips.find(t => t.id === state.activeTripId);
            document.getElementById('g-exp-involved').innerHTML = trip.members.map(m => {
                const sel = state.currentInvolved.has(m.id);
                return `<button type="button" onclick="toggleInvolved('${m.id}')" class="px-3 py-1.5 rounded-full text-xs font-medium border transition-all ${sel ? 'bg-slate-700 text-white border-slate-700' : 'bg-white text-slate-400 border-slate-200'}">${m.name}</button>`;
            }).join('');
            document.getElementById('g-involved-count').textContent = state.currentInvolved.size === trip.members.length ? '全員' : `${state.currentInvolved.size} 人`;
        }

        function toggleInvolved(id) {
            if(state.currentInvolved.has(id)) state.currentInvolved.delete(id);
            else state.currentInvolved.add(id);
            renderInvolvedButtons();
        }

        function addGroupExpense(e) {
            e.preventDefault();
            const trip = state.trips.find(t => t.id === state.activeTripId);
            const desc = document.getElementById('g-exp-desc').value;
            const amount = parseFloat(document.getElementById('g-exp-amount').value);
            const payerId = document.getElementById('g-exp-payer').value;
            if(!desc || !amount || state.currentInvolved.size === 0) return;
            
            trip.expenses.unshift({
                id: Date.now().toString(),
                description: desc, amount, payerId,
                involvedMemberIds: Array.from(state.currentInvolved),
                date: new Date().toLocaleDateString()
            });
            saveTrips();
            document.getElementById('g-exp-desc').value = '';
            document.getElementById('g-exp-amount').value = '';
            renderGroupExpenses();
        }

        function deleteGroupExpense(id) {
            if(!confirm('刪除此帳目?')) return;
            const trip = state.trips.find(t => t.id === state.activeTripId);
            trip.expenses = trip.expenses.filter(e => e.id !== id);
            saveTrips();
            renderGroupExpenses();
        }

        function renderGroupExpenses() {
            const trip = state.trips.find(t => t.id === state.activeTripId);
            const total = trip.expenses.reduce((s,e) => s+e.amount, 0);
            document.getElementById('g-total-cost').textContent = `$${Math.round(total).toLocaleString()}`;
            
            document.getElementById('g-expense-list').innerHTML = trip.expenses.map(exp => {
                const payer = trip.members.find(m => m.id === exp.payerId)?.name || '?';
                return `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center relative group">
                    <div>
                        <div class="text-sm font-medium text-slate-800">${exp.description}</div>
                        <div class="text-xs text-slate-400 mt-1"><span class="bg-slate-100 px-1 rounded text-slate-600">${payer}</span> 先付</div>
                    </div>
                    <div class="text-lg font-bold text-slate-800">$${exp.amount.toLocaleString()}</div>
                    <button onclick="deleteGroupExpense('${exp.id}')" class="absolute right-2 top-2 opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500">✕</button>
                </div>`;
            }).join('');
        }

        // --- Settlement Modal Logic ---
        function calculateStats() {
            const trip = state.trips.find(t => t.id === state.activeTripId);
            return trip.members.map(m => {
                const paid = trip.expenses.filter(e => e.payerId === m.id).reduce((s, e) => s + e.amount, 0);
                const share = trip.expenses.filter(e => e.involvedMemberIds.includes(m.id)).reduce((s, e) => s + (e.amount / e.involvedMemberIds.length), 0);
                return { ...m, paid, share, net: paid - share };
            });
        }

        function showSettlementModal(show) {
            const modal = document.getElementById('settlement-modal');
            if(show) {
                state.viewDetailMemberId = null;
                renderModalContent();
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function renderModalContent() {
            const header = document.getElementById('modal-header-content');
            const body = document.getElementById('modal-body');
            const trip = state.trips.find(t => t.id === state.activeTripId);
            const stats = calculateStats();

            if(state.viewDetailMemberId) {
                // Detail View
                const m = stats.find(x => x.id === state.viewDetailMemberId);
                header.innerHTML = `<button onclick="state.viewDetailMemberId=null; renderModalContent()" class="flex items-center gap-1 text-sm text-slate-300 hover:text-white">&larr; 返回</button><span class="font-bold text-lg ml-2">${m.name}</span>`;
                
                // Breakdown Calculation
                const receivables = [], payables = [];
                trip.expenses.forEach(exp => {
                    const split = exp.amount / exp.involvedMemberIds.length;
                    if(exp.payerId === m.id) { // I paid
                        exp.involvedMemberIds.forEach(id => {
                            if(id !== m.id) receivables.push({ name: trip.members.find(x=>x.id===id).name, item: exp.description, amt: split });
                        });
                    }
                    if(exp.payerId !== m.id && exp.involvedMemberIds.includes(m.id)) { // Someone paid for me
                         payables.push({ name: trip.members.find(x=>x.id===exp.payerId).name, item: exp.description, amt: split });
                    }
                });

                const renderItems = (list, color) => list.length ? list.map(x => `
                    <div class="flex justify-between text-sm py-2 border-b border-slate-50 last:border-0">
                        <span>${x.name} - ${x.item}</span><span class="font-mono font-bold text-${color}-500">$${Math.round(x.amt)}</span>
                    </div>`).join('') : '<div class="text-slate-300 text-sm italic">無</div>';

                body.innerHTML = `
                <div class="p-6 space-y-6">
                    <div><h4 class="text-sm font-bold text-slate-400 mb-2">別人欠我的 (應收)</h4><div class="bg-slate-50 rounded-xl p-4">${renderItems(receivables, 'green')}</div></div>
                    <div><h4 class="text-sm font-bold text-slate-400 mb-2">我欠別人的 (應付)</h4><div class="bg-slate-50 rounded-xl p-4">${renderItems(payables, 'red')}</div></div>
                </div>`;
            } else {
                // List View
                header.innerHTML = `<h3 class="font-bold text-lg">結算總覽</h3>`;
                
                // Greedy algo for suggestions
                const debtors = stats.filter(m=>m.net<-0.01).map(m=>({...m, net: -m.net})).sort((a,b)=>b.net-a.net);
                const creditors = stats.filter(m=>m.net>0.01).sort((a,b)=>b.net-a.net);
                const suggestions = [];
                let i=0, j=0;
                while(i<debtors.length && j<creditors.length) {
                    const d = debtors[i], c = creditors[j];
                    const amt = Math.min(d.net, c.net);
                    if(amt>0.01) suggestions.push({from: d.name, to: c.name, amt});
                    d.net-=amt; c.net-=amt;
                    if(d.net<0.01) i++; if(c.net<0.01) j++;
                }

                body.innerHTML = `
                <div class="divide-y divide-slate-100">
                    ${stats.map(m => `
                    <button onclick="state.viewDetailMemberId='${m.id}'; renderModalContent()" class="w-full p-4 hover:bg-slate-50 transition-colors flex items-center justify-between text-left">
                        <div>
                            <span class="font-bold text-slate-700">${m.name}</span>
                            <div class="text-xs text-slate-400 mt-1">已付 $${Math.round(m.paid)} • 應付 $${Math.round(m.share)}</div>
                        </div>
                        <div class="font-mono font-bold ${m.net > 0 ? 'text-green-500' : m.net < 0 ? 'text-red-500' : 'text-slate-400'}">${m.net > 0 ? '+' : ''}${Math.round(m.net)}</div>
                    </button>`).join('')}
                    <div class="p-6 bg-slate-50/50">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-3">建議結算</h4>
                        ${suggestions.length ? suggestions.map(s => `
                        <div class="flex justify-between bg-white p-3 rounded-lg border border-slate-200 mb-2 text-sm">
                            <span><span class="font-bold">${s.from}</span> 給 <span class="font-bold">${s.to}</span></span>
                            <span class="font-bold">$${Math.round(s.amt).toLocaleString()}</span>
                        </div>`).join('') : '<div class="text-center text-slate-400 text-sm">已結清</div>'}
                    </div>
                </div>`;
            }
        }

        // Start
        init();
    </script>
</body>
</html>